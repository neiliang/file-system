<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>文件管理</title>


    <script th:src="@{/jquery/jquery-3.5.1.min.js}" type="text/javascript"></script>
    <script th:src="@{/layui/layui.all.js}" type="text/javascript" charset="UTF-8"></script>

    <link rel="stylesheet" th:href="@{/layui/css/layui.css}" media="all">
</head>
<body>


<fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
    <legend>选完文件后不自动上传</legend>
</fieldset>

<div class="layui-upload">
    <button type="button" class="layui-btn layui-btn-normal" id="select_file">选择文件</button>
    <div class="layui-upload-list">
        <table class="layui-table">
            <thead>
            <tr>
                <th>文件名</th>
                <th>大小</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="demoList"></tbody>
        </table>
    </div>
    <button type="button" class="layui-btn" id="upload">开始上传</button>
</div>





<script type="text/javascript" th:inline="javascript">

    /*<![CDATA[*/
    var ctxPath = /*[[@{/}]]*/ '';
    /*]]>*/


    console.log("系统路径：" + ctxPath);

    layui.use('upload', function () {

        var $ = layui.jquery;
        var upload = layui.upload;


        var demoListView = $('#demoList');
        //选完文件后手动上传
        upload.render({
            accept: 'file', // 指定允许上传时校验的文件类型，可选值有：images（图片）、file（所有文件）、video（视频）、audio（音频）
            elem: '#select_file', // 指向容器选择器
            url: ctxPath + '/files/uploadFile', // 上传接口
            method: 'post', // 可选项。HTTP类型，默认post
            auto: false, // 是否选完文件后自动上传。如果设定 false，那么需要设置 bindAction 参数来指向一个其它按钮提交上传
            bindAction: '#upload', // 指向一个按钮触发上传，一般配合 auto: false 来使用。
            multiple: false, //是否允许多文件上传。设置 true即可开启。
            number: 1, // 设置同时可上传的文件数量，一般配合 multiple 参数出现。0-表示不限制
            drag: false, // 是否接受拖拽的文件上传，设置 false 可禁用。默认值：true
            size: 16000, //限制文件大小，单位 KB
            //exts: 'zip|rar|7z', //只允许上传压缩文件
            field: 'file', // 设定文件域的字段名, string类型，默认值："file"
            choose: function(obj) {
                //选择文件后的回调函数。
                var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列


                //预读本地文件，如果是多文件，则会遍历。(不支持ie8/9)
                obj.preview(function (index, file, result) {

                    /*
                    console.log(index); //得到文件索引
                    console.log(file); //得到文件对象
                    console.log(result); //得到文件base64编码，比如图片
                    */

                    var tr = $(['<tr id="upload-' + index + '">'
                        , '<td>' + file.name + '</td>'
                        , '<td>' + (file.size / 1024).toFixed(1) + 'kb</td>'
                        , '<td>等待上传</td>'
                        , '<td>'
                        , '<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>'
                        , '<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>'
                        , '</td>'
                        , '</tr>'].join(''));


                    tr.find('.demo-reload').on('click', function () {
                        obj.upload(index, file); //对上传失败的单个文件重新上传，一般在某个事件中使用
                    });

                    //删除
                    tr.find('.demo-delete').on('click', function () {
                        delete files[index]; //删除列表中对应的文件，一般在某个事件中使用
                        tr.remove();
                        this.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                    });

                    demoListView.append(tr);
                });
            },
            done: function(res, index, upload){

                delete this.files[index]; //删除文件队列已经上传成功的文件
                // 执行上传请求后的回调。

                console.log("res: "+JSON.stringify(res));

                if(res.code === 200){
                    demoListView.empty();
                    layer.msg('上传成功');
                }
            },
            error: function (index, upload) {
                layer.closeAll('loading'); //关闭loading
            }
        });

        //拖拽上传
        upload.render({
            elem: '#test10',
            url: 'https://httpbin.org/post', //改成您自己的上传接口
            done: function(res){

                layer.msg('上传成功');
                layui.$('#uploadDemoView').removeClass('layui-hide').find('img').attr('src', res.files.file);
                console.log(res)
            }
        });

        //拖拽上传
        upload.render({
            elem: '#test10',
            url: 'https://httpbin.org/post', //改成您自己的上传接口
            done: function(res){
                layer.msg('上传成功');
                layui.$('#uploadDemoView').removeClass('layui-hide').find('img').attr('src', res.files.file);
                console.log(res)
            }
        });




    });


</script>


</body>
</html>